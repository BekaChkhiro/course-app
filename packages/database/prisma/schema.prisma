// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  STUDENT
  ADMIN
}

enum CourseStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum ChapterContentType {
  VIDEO
  TEXT
  PDF
  QUIZ
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum VideoProcessingStatus {
  PENDING
  UPLOADING
  PROCESSING
  COMPLETED
  FAILED
}

enum VideoQuality {
  QUALITY_480P
  QUALITY_720P
  QUALITY_1080P
}

model User {
  id                    String    @id @default(cuid())
  email                 String    @unique
  password              String
  name                  String
  surname               String
  phone                 String?   @unique
  role                  UserRole  @default(STUDENT)
  avatar                String?
  bio                   String?
  isActive              Boolean   @default(true)
  emailVerified         Boolean   @default(false)
  verificationToken     String?   @unique
  resetPasswordToken    String?   @unique
  resetPasswordExpires  DateTime?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // Relations
  purchases      Purchase[]
  progress       Progress[]
  comments       Comment[]
  reviews        Review[]
  deviceSessions DeviceSession[]
  authoredCourses Course[]

  @@index([email])
  @@index([phone])
  @@index([verificationToken])
  @@index([resetPasswordToken])
  @@map("users")
}

model Category {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  description String?
  icon        String?
  order       Int      @default(0)
  parentId    String? // For hierarchical categories
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children Category[] @relation("CategoryHierarchy")
  courses  Course[]

  @@index([slug])
  @@index([parentId])
  @@map("categories")
}

model Course {
  id          String       @id @default(cuid())
  title       String
  slug        String       @unique
  description String       @db.Text
  thumbnail   String?
  price       Decimal      @db.Decimal(10, 2)
  status      CourseStatus @default(DRAFT)
  categoryId  String
  authorId    String

  // SEO metadata
  metaTitle       String?
  metaDescription String?
  metaKeywords    String?

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Relations
  category        Category        @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  author          User            @relation(fields: [authorId], references: [id], onDelete: Cascade)
  versions        CourseVersion[]
  purchases       Purchase[]
  reviews         Review[]
  activeVersionId String?         @unique

  @@index([slug])
  @@index([categoryId])
  @@index([authorId])
  @@index([status])
  @@map("courses")
}

model CourseVersion {
  id          String   @id @default(cuid())
  courseId    String
  version     Int
  title       String
  description String   @db.Text
  changelog   String?  @db.Text // Version changelog for upgrade info

  // Upgrade pricing for existing students
  upgradePrice        Decimal? @db.Decimal(10, 2)
  discountPercentage  Decimal? @db.Decimal(5, 2) // Discount % for existing students

  isActive    Boolean  @default(false)
  publishedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  course   Course     @relation(fields: [courseId], references: [id], onDelete: Cascade)
  chapters Chapter[]
  progress Progress[]

  @@unique([courseId, version])
  @@index([courseId])
  @@index([isActive])
  @@map("course_versions")
}

model Chapter {
  id              String   @id @default(cuid())
  courseVersionId String
  title           String
  description     String?  @db.Text
  order           Int
  isFree          Boolean  @default(false)

  // Chapter components
  videoUrl        String? // Video URL (legacy)
  theory          String?  @db.Text // Rich text theory content
  assignmentFile  String? // Assignment file URL
  answerFile      String? // Answer file URL

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  courseVersion CourseVersion    @relation(fields: [courseVersionId], references: [id], onDelete: Cascade)
  contents      ChapterContent[]
  comments      Comment[]
  progress      Progress[]
  videos        Video[]

  @@index([courseVersionId])
  @@index([order])
  @@map("chapters")
}

model ChapterContent {
  id          String             @id @default(cuid())
  chapterId   String
  type        ChapterContentType
  title       String
  content     String             @db.Text // URL for video/pdf, HTML for text
  duration    Int? // Duration in seconds for video content
  fileSize    Int? // File size in bytes
  mimeType    String?
  order       Int
  isFree      Boolean            @default(false)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  // Relations
  chapter  Chapter   @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  quiz     Quiz?

  @@index([chapterId])
  @@index([type])
  @@index([order])
  @@map("chapter_contents")
}

model Quiz {
  id               String   @id @default(cuid())
  chapterContentId String   @unique
  title            String
  description      String?
  passingScore     Int      @default(70) // Percentage
  maxAttempts      Int?
  timeLimit        Int? // Time limit in minutes
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  chapterContent ChapterContent @relation(fields: [chapterContentId], references: [id], onDelete: Cascade)
  questions      QuizQuestion[]
  submissions    QuizSubmission[]

  @@map("quizzes")
}

model QuizQuestion {
  id        String   @id @default(cuid())
  quizId    String
  question  String   @db.Text
  order     Int
  points    Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  quiz    Quiz         @relation(fields: [quizId], references: [id], onDelete: Cascade)
  answers QuizAnswer[]
  userAnswers QuizUserAnswer[]

  @@index([quizId])
  @@index([order])
  @@map("quiz_questions")
}

model QuizAnswer {
  id         String   @id @default(cuid())
  questionId String
  answer     String   @db.Text
  isCorrect  Boolean  @default(false)
  order      Int
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  question QuizQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  userAnswers QuizUserAnswer[]

  @@index([questionId])
  @@map("quiz_answers")
}

model QuizSubmission {
  id          String   @id @default(cuid())
  userId      String
  quizId      String
  score       Decimal  @db.Decimal(5, 2)
  passed      Boolean
  attemptNumber Int
  startedAt   DateTime
  completedAt DateTime @default(now())

  // Relations
  quiz        Quiz             @relation(fields: [quizId], references: [id], onDelete: Cascade)
  userAnswers QuizUserAnswer[]

  @@index([userId])
  @@index([quizId])
  @@map("quiz_submissions")
}

model QuizUserAnswer {
  id           String @id @default(cuid())
  submissionId String
  questionId   String
  answerId     String

  // Relations
  submission QuizSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  question   QuizQuestion   @relation(fields: [questionId], references: [id], onDelete: Cascade)
  answer     QuizAnswer     @relation(fields: [answerId], references: [id], onDelete: Cascade)

  @@unique([submissionId, questionId])
  @@index([submissionId])
  @@map("quiz_user_answers")
}

model Purchase {
  id          String        @id @default(cuid())
  userId      String
  courseId    String
  amount      Decimal       @db.Decimal(10, 2)
  finalAmount Decimal       @db.Decimal(10, 2) // After discount
  status      PaymentStatus @default(PENDING)
  promoCodeId String?
  stripePaymentId String?   @unique
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relations
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  course    Course     @relation(fields: [courseId], references: [id], onDelete: Cascade)
  promoCode PromoCode? @relation(fields: [promoCodeId], references: [id])

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
  @@index([status])
  @@map("purchases")
}

model Progress {
  id              String   @id @default(cuid())
  userId          String
  courseVersionId String
  chapterId       String
  isCompleted     Boolean  @default(false)
  lastPosition    Int?     @default(0) // Last video position in seconds
  watchPercentage Decimal  @default(0) @db.Decimal(5, 2) // Percentage watched (0-100)
  totalWatchTime  Int      @default(0) // Total seconds watched
  canSkipAhead    Boolean  @default(false) // Whether user can skip ahead (after first complete watch)
  firstWatchCompleted Boolean @default(false) // Has completed first full watch
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  courseVersion CourseVersion @relation(fields: [courseVersionId], references: [id], onDelete: Cascade)
  chapter       Chapter       @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, chapterId])
  @@index([userId])
  @@index([courseVersionId])
  @@index([isCompleted])
  @@map("progress")
}

model Comment {
  id        String   @id @default(cuid())
  userId    String
  chapterId String
  content   String   @db.Text
  parentId  String? // For nested comments
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user    User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  chapter Chapter   @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  parent  Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies Comment[] @relation("CommentReplies")

  @@index([userId])
  @@index([chapterId])
  @@index([parentId])
  @@map("comments")
}

model Review {
  id        String   @id @default(cuid())
  userId    String
  courseId  String
  rating    Int // 1-5 stars
  comment   String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
  @@index([rating])
  @@map("reviews")
}

model PromoCode {
  id          String    @id @default(cuid())
  code        String    @unique
  description String?
  discount    Decimal   @db.Decimal(5, 2) // Percentage (0-100)
  validFrom   DateTime
  validUntil  DateTime
  maxUses     Int?
  usedCount   Int       @default(0)
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  purchases Purchase[]

  @@index([code])
  @@index([validFrom, validUntil])
  @@map("promo_codes")
}

model DeviceSession {
  id                String   @id @default(cuid())
  userId            String
  deviceName        String
  deviceType        String // mobile, tablet, desktop
  deviceFingerprint String
  browser           String?
  ipAddress         String
  userAgent         String   @db.Text
  refreshToken      String   @unique @db.Text
  isActive          Boolean  @default(true)
  lastActiveAt      DateTime @default(now())
  createdAt         DateTime @default(now())
  expiresAt         DateTime

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, deviceFingerprint])
  @@index([userId])
  @@index([userId, isActive])
  @@index([refreshToken])
  @@map("device_sessions")
}

model Video {
  id              String                 @id @default(cuid())
  chapterId       String
  originalName    String
  originalSize    Int // Size in bytes
  mimeType        String
  duration        Int? // Duration in seconds
  width           Int?
  height          Int?

  // R2 Storage
  r2Key           String                 @unique // Path in R2 bucket
  r2Bucket        String

  // HLS Outputs
  hlsMasterUrl    String? // Master playlist URL
  hls480pUrl      String? // 480p variant URL
  hls720pUrl      String? // 720p variant URL
  hls1080pUrl     String? // 1080p variant URL

  // Encryption
  encryptionKey   String? // AES-128 encryption key
  encryptionIv    String? // Initialization vector
  keyRotationAt   DateTime? // When to rotate encryption key

  // Processing
  processingStatus VideoProcessingStatus @default(PENDING)
  processingJobId  String?
  processingError  String?                @db.Text
  processingProgress Int?                 @default(0) // 0-100

  // Metadata
  metadata        Json? // Additional video metadata

  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt
  processedAt     DateTime?

  // Relations
  chapter         Chapter                @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  thumbnails      VideoThumbnail[]
  accessTokens    VideoAccessToken[]
  analytics       VideoAnalytics[]
  processingJobs  VideoProcessingJob[]

  @@index([chapterId])
  @@index([processingStatus])
  @@index([r2Key])
  @@map("videos")
}

model VideoThumbnail {
  id          String   @id @default(cuid())
  videoId     String
  r2Key       String   @unique
  url         String
  timeOffset  Int // Time in seconds where thumbnail was captured
  width       Int
  height      Int
  createdAt   DateTime @default(now())

  // Relations
  video Video @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@index([videoId])
  @@index([timeOffset])
  @@map("video_thumbnails")
}

model VideoProcessingJob {
  id            String                 @id @default(cuid())
  videoId       String
  jobType       String // "hls_conversion", "thumbnail_generation", "metadata_extraction"
  quality       VideoQuality?
  status        VideoProcessingStatus  @default(PENDING)
  progress      Int                    @default(0) // 0-100
  error         String?                @db.Text
  startedAt     DateTime?
  completedAt   DateTime?
  createdAt     DateTime               @default(now())
  updatedAt     DateTime               @updatedAt

  // Relations
  video Video @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@index([videoId])
  @@index([status])
  @@map("video_processing_jobs")
}

model VideoAccessToken {
  id          String   @id @default(cuid())
  videoId     String
  userId      String
  token       String   @unique
  ipAddress   String
  expiresAt   DateTime
  isRevoked   Boolean  @default(false)
  accessCount Int      @default(0)
  createdAt   DateTime @default(now())
  lastAccessedAt DateTime?

  // Relations
  video Video @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@index([videoId])
  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("video_access_tokens")
}

model VideoAnalytics {
  id             String   @id @default(cuid())
  videoId        String
  userId         String
  sessionId      String // Unique session identifier
  watchDuration  Int      @default(0) // Total seconds watched
  completionRate Decimal  @db.Decimal(5, 2) // Percentage watched
  quality        VideoQuality? // Quality viewed
  bandwidthUsed  Int?     @default(0) // Bytes transferred
  ipAddress      String
  userAgent      String   @db.Text
  deviceType     String?
  browser        String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  video Video @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@index([videoId])
  @@index([userId])
  @@index([sessionId])
  @@index([createdAt])
  @@map("video_analytics")
}
