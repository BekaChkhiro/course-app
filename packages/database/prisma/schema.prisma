// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  STUDENT
  ADMIN
}

enum CourseStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum ChapterContentType {
  VIDEO
  TEXT
  PDF
  QUIZ
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum VideoProcessingStatus {
  PENDING
  UPLOADING
  PROCESSING
  COMPLETED
  FAILED
}

enum VideoQuality {
  QUALITY_480P
  QUALITY_720P
  QUALITY_1080P
}

enum QuestionType {
  SINGLE_CHOICE
  MULTIPLE_CHOICE
  TRUE_FALSE
}

enum QuizType {
  CHAPTER_QUIZ
  FINAL_EXAM
  PRACTICE_QUIZ
}

enum QuizAttemptStatus {
  IN_PROGRESS
  COMPLETED
  ABANDONED
  TIME_EXPIRED
}

enum VersionStatus {
  DRAFT
  PUBLISHED
}

enum UpgradePriceType {
  FIXED       // ფიქსირებული თანხა
  PERCENTAGE  // კურსის ფასის პროცენტი
}

model User {
  id                    String    @id @default(cuid())
  email                 String    @unique
  password              String
  name                  String
  surname               String
  phone                 String?   @unique
  role                  UserRole  @default(STUDENT)
  avatar                String?
  bio                   String?
  isActive              Boolean   @default(true)
  emailVerified         Boolean   @default(false)
  verificationToken     String?   @unique
  resetPasswordToken    String?   @unique
  resetPasswordExpires  DateTime?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // Relations
  purchases       Purchase[]
  progress        Progress[]
  comments        Comment[]
  reviews         Review[]
  deviceSessions  DeviceSession[]
  authoredCourses Course[]
  notes           Note[]
  bookmarks       Bookmark[]
  studyStreak     StudyStreak?
  userBadges      UserBadge[]
  userXP          UserXP?
  preferences     UserPreferences?

  // Communication system relations
  sentMessages      StudentMessage[]  @relation("StudentMessages")
  assignedMessages  StudentMessage[]  @relation("AssignedMessages")
  messageReplies    MessageReply[]    @relation("MessageReplies")
  cannedResponses   CannedResponse[]  @relation("CannedResponses")
  reviewVotes       ReviewVote[]      @relation("ReviewVotes")
  reviewResponses   ReviewResponse[]  @relation("ReviewResponses")
  moderatedReviews  Review[]          @relation("ModeratedReviews")

  @@index([email])
  @@index([phone])
  @@index([verificationToken])
  @@index([resetPasswordToken])
  @@map("users")
}

model Category {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  description String?
  icon        String?
  order       Int      @default(0)
  parentId    String? // For hierarchical categories
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children Category[] @relation("CategoryHierarchy")
  courses  Course[]

  @@index([slug])
  @@index([parentId])
  @@map("categories")
}

model Course {
  id          String       @id @default(cuid())
  title       String
  slug        String       @unique
  description String       @db.Text
  thumbnail   String?
  price       Decimal      @db.Decimal(10, 2)
  status      CourseStatus @default(DRAFT)
  categoryId  String
  authorId    String
  instructorId String?

  // SEO metadata
  metaTitle       String?
  metaDescription String?
  metaKeywords    String?

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Relations
  category        Category        @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  author          User            @relation(fields: [authorId], references: [id], onDelete: Cascade)
  instructor      Instructor?     @relation(fields: [instructorId], references: [id], onDelete: SetNull)
  versions        CourseVersion[]
  purchases       Purchase[]
  reviews         Review[]
  messages        StudentMessage[]
  activeVersionId String?         @unique

  @@index([slug])
  @@index([categoryId])
  @@index([authorId])
  @@index([instructorId])
  @@index([status])
  @@map("courses")
}

model CourseVersion {
  id          String   @id @default(cuid())
  courseId    String
  version     Int
  title       String
  description String   @db.Text
  changelog   String?  @db.Text // Version changelog for upgrade info

  // Upgrade pricing for existing students (v2+ only, v1 doesn't need this)
  upgradePriceType   UpgradePriceType?           // FIXED or PERCENTAGE
  upgradePriceValue  Decimal?         @db.Decimal(10, 2) // თანხა ან პროცენტი

  status      VersionStatus @default(DRAFT)
  isActive    Boolean  @default(false)
  publishedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  course     Course     @relation(fields: [courseId], references: [id], onDelete: Cascade)
  chapters   Chapter[]
  progress   Progress[]
  finalExams Quiz[]     // Final exams for this version
  purchases  Purchase[] // შეძენები ამ ვერსიისთვის

  @@unique([courseId, version])
  @@index([courseId])
  @@index([isActive])
  @@index([status])
  @@map("course_versions")
}

model Chapter {
  id              String   @id @default(cuid())
  courseVersionId String
  title           String
  description     String?  @db.Text
  order           Int
  isFree          Boolean  @default(false)

  // Chapter components
  videoUrl        String? // Video URL (legacy)
  theory          String?  @db.Text // Rich text theory content
  assignmentFile  String? // Assignment file URL
  answerFile      String? // Answer file URL

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  courseVersion CourseVersion    @relation(fields: [courseVersionId], references: [id], onDelete: Cascade)
  contents      ChapterContent[]
  comments      Comment[]
  progress      Progress[]
  videos        Video[]
  quiz          Quiz?
  notes         Note[]
  bookmarks     Bookmark[]
  attachments   ChapterAttachment[]

  @@index([courseVersionId])
  @@index([order])
  @@map("chapters")
}

model ChapterContent {
  id          String             @id @default(cuid())
  chapterId   String
  type        ChapterContentType
  title       String
  content     String             @db.Text // URL for video/pdf, HTML for text
  duration    Int? // Duration in seconds for video content
  fileSize    Int? // File size in bytes
  mimeType    String?
  order       Int
  isFree      Boolean            @default(false)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  // Relations
  chapter  Chapter   @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  quiz     Quiz?

  @@index([chapterId])
  @@index([type])
  @@index([order])
  @@map("chapter_contents")
}

model ChapterAttachment {
  id          String   @id @default(cuid())
  chapterId   String
  title       String
  description String?
  fileName    String   // Original file name
  filePath    String   // Path in R2 storage
  fileSize    Int      // Size in bytes
  mimeType    String   // e.g., application/pdf, image/png
  type        String   @default("material") // material, assignment, answer
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  chapter Chapter @relation(fields: [chapterId], references: [id], onDelete: Cascade)

  @@index([chapterId])
  @@index([chapterId, type])
  @@index([order])
  @@map("chapter_attachments")
}

model Quiz {
  id               String   @id @default(cuid())
  chapterContentId String?  @unique // Optional for standalone quizzes
  chapterId        String?  @unique // Direct link to chapter
  courseVersionId  String?  // For final exams linked to course versions
  title            String
  description      String?  @db.Text
  type             QuizType @default(CHAPTER_QUIZ)

  // Scoring settings
  passingScore     Int      @default(70) // Percentage
  totalPoints      Int      @default(0) // Auto-calculated from questions
  showScore        Boolean  @default(true)
  showCorrectAnswers Boolean @default(true)
  showExplanations Boolean  @default(true)

  // Attempt settings
  maxAttempts      Int?     // Null = unlimited
  timeLimit        Int?     // Time limit in minutes (0 = no limit)

  // Display settings
  oneQuestionPerPage Boolean @default(true)
  randomizeQuestions Boolean @default(false)
  randomizeAnswers   Boolean @default(false)
  showProgressBar    Boolean @default(true)

  // Anti-cheating
  preventTabSwitch   Boolean @default(false)
  preventCopyPaste   Boolean @default(false)
  logAttemptDetails  Boolean @default(true)
  requireFullscreen  Boolean @default(false)

  // Final exam specific
  lockUntilChaptersComplete Boolean @default(false)
  generateCertificate       Boolean @default(false)
  requirePassing            Boolean @default(false)

  // Template
  isTemplate       Boolean  @default(false)
  templateName     String?

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  chapterContent ChapterContent? @relation(fields: [chapterContentId], references: [id], onDelete: Cascade)
  chapter        Chapter?        @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  courseVersion  CourseVersion?  @relation(fields: [courseVersionId], references: [id], onDelete: Cascade)
  questions      QuizQuestion[]
  attempts       QuizAttempt[]
  analytics      QuizAnalytics[]

  @@index([type])
  @@index([isTemplate])
  @@index([courseVersionId])
  @@index([chapterId])
  @@map("quizzes")
}

model QuizQuestion {
  id             String       @id @default(cuid())
  quizId         String?      // Null if in question bank only
  questionBankId String?      // Link to question bank

  type           QuestionType @default(SINGLE_CHOICE)
  question       String       @db.Text
  questionImage  String?      // Image URL for question
  explanation    String?      @db.Text // Explanation for correct answer

  order          Int
  points         Int          @default(1)

  // Question bank fields
  category       String?
  tags           String[]     // Array of tags for filtering
  difficulty     String?      // easy, medium, hard
  usageCount     Int          @default(0) // How many times used

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  // Relations
  quiz           Quiz?          @relation(fields: [quizId], references: [id], onDelete: Cascade)
  questionBank   QuestionBank?  @relation(fields: [questionBankId], references: [id], onDelete: SetNull)
  answers        QuizAnswer[]
  responses      QuizResponse[]

  @@index([quizId])
  @@index([questionBankId])
  @@index([order])
  @@index([category])
  @@map("quiz_questions")
}

model QuizAnswer {
  id          String   @id @default(cuid())
  questionId  String
  answer      String   @db.Text
  answerImage String?  // Optional image for answer
  isCorrect   Boolean  @default(false)
  order       Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  question QuizQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([questionId])
  @@map("quiz_answers")
}

model QuizAttempt {
  id              String            @id @default(cuid())
  userId          String
  quizId          String
  attemptNumber   Int
  status          QuizAttemptStatus @default(IN_PROGRESS)

  // Scoring
  score           Decimal?          @db.Decimal(5, 2) // Percentage
  pointsEarned    Int?
  totalPoints     Int?
  passed          Boolean?

  // Timing
  startedAt       DateTime          @default(now())
  completedAt     DateTime?
  timeSpent       Int?              // Seconds
  timeRemaining   Int?              // Seconds when submitted

  // Anti-cheating tracking
  ipAddress       String
  userAgent       String            @db.Text
  tabSwitchCount  Int               @default(0)
  copyPasteCount  Int               @default(0)
  suspiciousActivity Json?          // Log of suspicious events

  // Progress tracking
  currentQuestionIndex Int           @default(0)
  questionsAnswered    Int           @default(0)
  markedForReview      String[]      // Question IDs marked for review

  // Auto-save data
  lastSavedAt     DateTime?
  autoSaveData    Json?             // Temporary answers before submission

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  // Relations
  quiz      Quiz           @relation(fields: [quizId], references: [id], onDelete: Cascade)
  responses QuizResponse[]
  certificate Certificate?

  @@unique([userId, quizId, attemptNumber])
  @@index([userId])
  @@index([quizId])
  @@index([status])
  @@map("quiz_attempts")
}

model QuizResponse {
  id           String   @id @default(cuid())
  attemptId    String
  questionId   String
  answerIds    String[] // Array to support multiple choice questions

  isCorrect    Boolean?
  pointsEarned Int      @default(0)
  timeSpent    Int?     // Seconds spent on this question

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  attempt  QuizAttempt  @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  question QuizQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([attemptId, questionId])
  @@index([attemptId])
  @@index([questionId])
  @@map("quiz_responses")
}

model QuestionBank {
  id          String   @id @default(cuid())
  name        String
  description String?  @db.Text
  category    String
  tags        String[]
  isPublic    Boolean  @default(false)
  createdBy   String   // User ID who created it

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  questions QuizQuestion[]

  @@index([category])
  @@index([createdBy])
  @@map("question_banks")
}

model Certificate {
  id              String   @id @default(cuid())
  attemptId       String   @unique
  userId          String
  courseId        String
  quizId          String

  certificateNumber String @unique
  issuedAt          DateTime @default(now())
  expiresAt         DateTime?

  // Certificate data
  studentName     String
  courseName      String
  quizTitle       String
  score           Decimal  @db.Decimal(5, 2)
  completionDate  DateTime

  // PDF generation
  pdfUrl          String?
  pdfGeneratedAt  DateTime?

  createdAt       DateTime @default(now())

  // Relations
  attempt QuizAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([courseId])
  @@index([certificateNumber])
  @@map("certificates")
}

model QuizAnalytics {
  id                String   @id @default(cuid())
  quizId            String
  date              DateTime @default(now())

  // Daily aggregated stats
  totalAttempts     Int      @default(0)
  completedAttempts Int      @default(0)
  averageScore      Decimal? @db.Decimal(5, 2)
  passRate          Decimal? @db.Decimal(5, 2)
  averageTime       Int?     // Average time in seconds

  // Question performance
  questionStats     Json?    // Per-question statistics

  updatedAt         DateTime @updatedAt

  // Relations
  quiz Quiz @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@unique([quizId, date])
  @@index([quizId])
  @@index([date])
  @@map("quiz_analytics")
}

model Purchase {
  id              String        @id @default(cuid())
    userId          String
    courseId        String
    courseVersionId String?       // რომელი ვერსია იყიდა
    amount          Decimal       @db.Decimal(10, 2)
    finalAmount     Decimal       @db.Decimal(10, 2)
    status          PaymentStatus @default(PENDING)
    promoCodeId     String?
    isUpgrade       Boolean       @default(false) // თუ განახლებაა და არა ახალი შეძენა

    // BOG Payment fields (ახალი ველები)
    bogOrderId      String?       @unique  // BOG-ს შეკვეთის ID
    externalOrderId String?       @unique  // შენი სისტემის უნიკალური ID
    paymentMethod   String?                // card, google_pay, apple_pay, etc.
    transactionId   String?                // BOG transaction ID
    paymentDetails  Json?                  // სრული გადახდის დეტალები
    paidAt          DateTime?              // გადახდის დრო

    // Legacy field (შეგიძლია წაშალო თუ Stripe არ გიყენია)
    stripePaymentId String?       @unique

    createdAt       DateTime      @default(now())
    updatedAt       DateTime      @updatedAt

    // Relations
    user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
    course        Course         @relation(fields: [courseId], references: [id], onDelete: Cascade)
    courseVersion CourseVersion? @relation(fields: [courseVersionId], references: [id])
    promoCode     PromoCode?     @relation(fields: [promoCodeId], references: [id])

    @@unique([userId, courseId])
    @@index([userId])
    @@index([courseId])
    @@index([status])
    @@index([bogOrderId])
    @@map("purchases")
}

model Progress {
  id              String   @id @default(cuid())
  userId          String
  courseVersionId String
  chapterId       String
  isCompleted     Boolean  @default(false)
  lastPosition    Int?     @default(0) // Last video position in seconds
  watchPercentage Decimal  @default(0) @db.Decimal(5, 2) // Percentage watched (0-100)
  totalWatchTime  Int      @default(0) // Total seconds watched
  canSkipAhead    Boolean  @default(false) // Whether user can skip ahead (after first complete watch)
  firstWatchCompleted Boolean @default(false) // Has completed first full watch
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  courseVersion CourseVersion @relation(fields: [courseVersionId], references: [id], onDelete: Cascade)
  chapter       Chapter       @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, chapterId])
  @@index([userId])
  @@index([courseVersionId])
  @@index([isCompleted])
  @@map("progress")
}

model Comment {
  id        String   @id @default(cuid())
  userId    String
  chapterId String
  content   String   @db.Text
  parentId  String? // For nested comments
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user    User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  chapter Chapter   @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  parent  Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies Comment[] @relation("CommentReplies")

  @@index([userId])
  @@index([chapterId])
  @@index([parentId])
  @@map("comments")
}

model Review {
  id          String       @id @default(cuid())
  userId      String
  courseId    String
  rating      Int          // 1-5 stars (can store half-stars as x10, e.g., 45 = 4.5)
  title       String?      // Review title
  comment     String?      @db.Text
  pros        String?      @db.Text // What they liked
  cons        String?      @db.Text // What could be improved
  wouldRecommend Boolean?  // Would recommend to others
  isAnonymous Boolean      @default(false)
  status      ReviewStatus @default(PENDING)

  // Moderation
  moderatedById   String?
  moderatedAt     DateTime?
  rejectionReason String?   @db.Text

  // User completion info at time of review
  completionPercentage Int  @default(0)

  // Voting stats (denormalized for performance)
  helpfulCount    Int      @default(0)
  notHelpfulCount Int      @default(0)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  course      Course          @relation(fields: [courseId], references: [id], onDelete: Cascade)
  moderatedBy User?           @relation("ModeratedReviews", fields: [moderatedById], references: [id], onDelete: SetNull)
  response    ReviewResponse?
  votes       ReviewVote[]

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
  @@index([rating])
  @@index([status])
  @@index([createdAt])
  @@map("reviews")
}

model PromoCode {
  id          String    @id @default(cuid())
  code        String    @unique
  description String?
  discount    Decimal   @db.Decimal(5, 2) // Percentage (0-100)
  validFrom   DateTime
  validUntil  DateTime
  maxUses     Int?
  usedCount   Int       @default(0)
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  purchases Purchase[]

  @@index([code])
  @@index([validFrom, validUntil])
  @@map("promo_codes")
}

model DeviceSession {
  id                String   @id @default(cuid())
  userId            String
  deviceName        String
  deviceType        String // mobile, tablet, desktop
  deviceFingerprint String
  browser           String?
  ipAddress         String
  userAgent         String   @db.Text
  refreshToken      String   @unique @db.Text
  isActive          Boolean  @default(true)
  lastActiveAt      DateTime @default(now())
  createdAt         DateTime @default(now())
  expiresAt         DateTime

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, deviceFingerprint])
  @@index([userId])
  @@index([userId, isActive])
  @@index([refreshToken])
  @@map("device_sessions")
}

model Video {
  id              String                 @id @default(cuid())
  chapterId       String
  originalName    String
  originalSize    Int // Size in bytes
  mimeType        String
  duration        Int? // Duration in seconds
  width           Int?
  height          Int?

  // R2 Storage
  r2Key           String                 @unique // Path in R2 bucket
  r2Bucket        String

  // HLS Outputs
  hlsMasterUrl    String? // Master playlist URL
  hls480pUrl      String? // 480p variant URL
  hls720pUrl      String? // 720p variant URL
  hls1080pUrl     String? // 1080p variant URL

  // Encryption
  encryptionKey   String? // AES-128 encryption key
  encryptionIv    String? // Initialization vector
  keyRotationAt   DateTime? // When to rotate encryption key

  // Processing
  processingStatus VideoProcessingStatus @default(PENDING)
  processingJobId  String?
  processingError  String?                @db.Text
  processingProgress Int?                 @default(0) // 0-100

  // Metadata
  metadata        Json? // Additional video metadata

  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt
  processedAt     DateTime?

  // Relations
  chapter         Chapter                @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  thumbnails      VideoThumbnail[]
  accessTokens    VideoAccessToken[]
  analytics       VideoAnalytics[]
  processingJobs  VideoProcessingJob[]
  bookmarks       Bookmark[]

  @@index([chapterId])
  @@index([processingStatus])
  @@index([r2Key])
  @@map("videos")
}

model VideoThumbnail {
  id          String   @id @default(cuid())
  videoId     String
  r2Key       String   @unique
  url         String
  timeOffset  Int // Time in seconds where thumbnail was captured
  width       Int
  height      Int
  createdAt   DateTime @default(now())

  // Relations
  video Video @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@index([videoId])
  @@index([timeOffset])
  @@map("video_thumbnails")
}

model VideoProcessingJob {
  id            String                 @id @default(cuid())
  videoId       String
  jobType       String // "hls_conversion", "thumbnail_generation", "metadata_extraction"
  quality       VideoQuality?
  status        VideoProcessingStatus  @default(PENDING)
  progress      Int                    @default(0) // 0-100
  error         String?                @db.Text
  startedAt     DateTime?
  completedAt   DateTime?
  createdAt     DateTime               @default(now())
  updatedAt     DateTime               @updatedAt

  // Relations
  video Video @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@index([videoId])
  @@index([status])
  @@map("video_processing_jobs")
}

model VideoAccessToken {
  id          String   @id @default(cuid())
  videoId     String
  userId      String
  token       String   @unique
  ipAddress   String
  expiresAt   DateTime
  isRevoked   Boolean  @default(false)
  accessCount Int      @default(0)
  createdAt   DateTime @default(now())
  lastAccessedAt DateTime?

  // Relations
  video Video @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@index([videoId])
  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("video_access_tokens")
}

model VideoAnalytics {
  id             String   @id @default(cuid())
  videoId        String
  userId         String
  sessionId      String // Unique session identifier
  watchDuration  Int      @default(0) // Total seconds watched
  completionRate Decimal  @db.Decimal(5, 2) // Percentage watched
  quality        VideoQuality? // Quality viewed
  bandwidthUsed  Int?     @default(0) // Bytes transferred
  ipAddress      String
  userAgent      String   @db.Text
  deviceType     String?
  browser        String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  video Video @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([videoId, userId, sessionId])
  @@index([videoId])
  @@index([userId])
  @@index([sessionId])
  @@index([createdAt])
  @@map("video_analytics")
}

// ==========================================
// STUDENT LEARNING FEATURES
// ==========================================

model Note {
  id          String   @id @default(cuid())
  userId      String
  chapterId   String
  content     String   @db.Text
  highlightedText String? @db.Text // Original text that was highlighted
  color       String?  @default("yellow") // Highlight color
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  chapter Chapter @relation(fields: [chapterId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([chapterId])
  @@index([userId, chapterId])
  @@map("notes")
}

model Bookmark {
  id          String   @id @default(cuid())
  userId      String
  chapterId   String
  videoId     String?
  timestamp   Int?     // Video timestamp in seconds
  title       String   // User-defined title for the bookmark
  description String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  chapter Chapter @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  video   Video?  @relation(fields: [videoId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([chapterId])
  @@index([videoId])
  @@map("bookmarks")
}

model StudyStreak {
  id            String   @id @default(cuid())
  userId        String   @unique
  currentStreak Int      @default(0)
  longestStreak Int      @default(0)
  lastStudyDate DateTime?
  streakStartDate DateTime?
  totalStudyDays Int     @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("study_streaks")
}

model StudySession {
  id          String   @id @default(cuid())
  userId      String
  courseId    String?
  chapterId   String?
  startedAt   DateTime @default(now())
  endedAt     DateTime?
  duration    Int?     // Duration in seconds
  xpEarned    Int      @default(0)
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([courseId])
  @@index([startedAt])
  @@map("study_sessions")
}

model Badge {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  description String
  icon        String   // Icon name or URL
  category    String   // streak, completion, engagement, achievement
  requirement Json     // Requirements to earn the badge
  xpReward    Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  userBadges UserBadge[]

  @@index([slug])
  @@index([category])
  @@map("badges")
}

model UserBadge {
  id        String   @id @default(cuid())
  userId    String
  badgeId   String
  earnedAt  DateTime @default(now())
  notified  Boolean  @default(false)

  // Relations
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge Badge @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
  @@index([userId])
  @@index([badgeId])
  @@map("user_badges")
}

model UserXP {
  id          String   @id @default(cuid())
  userId      String   @unique
  totalXP     Int      @default(0)
  level       Int      @default(1)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  xpHistory   XPHistory[]

  @@index([userId])
  @@index([totalXP])
  @@map("user_xp")
}

model XPHistory {
  id          String   @id @default(cuid())
  userXPId    String
  amount      Int
  reason      String   // chapter_complete, quiz_pass, streak_bonus, etc.
  sourceId    String?  // ID of the related entity (chapter, quiz, etc.)
  sourceType  String?  // chapter, quiz, course, etc.
  createdAt   DateTime @default(now())

  // Relations
  userXP UserXP @relation(fields: [userXPId], references: [id], onDelete: Cascade)

  @@index([userXPId])
  @@index([createdAt])
  @@map("xp_history")
}

model UserPreferences {
  id                    String   @id @default(cuid())
  userId                String   @unique
  emailNotifications    Boolean  @default(true)
  progressReminders     Boolean  @default(true)
  weeklyReports         Boolean  @default(true)
  reminderTime          String?  // HH:MM format
  reminderDays          String[] // ["monday", "wednesday", "friday"]
  theme                 String   @default("light") // light, dark, system
  language              String   @default("en")
  // Communication preferences
  commentNotifications  Boolean  @default(true)
  reviewNotifications   Boolean  @default(true)
  marketingEmails       Boolean  @default(false)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_preferences")
}

// ==========================================
// COMMUNICATION & REVIEW SYSTEM
// ==========================================

enum MessageStatus {
  NEW
  READ
  IN_PROGRESS
  ANSWERED
  RESOLVED
  ARCHIVED
}

enum MessagePriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
  FLAGGED
}

model StudentMessage {
  id            String          @id @default(cuid())
  userId        String
  courseId      String?
  chapterId     String?
  subject       String
  content       String          @db.Text
  attachmentUrl String?
  status        MessageStatus   @default(NEW)
  priority      MessagePriority @default(MEDIUM)

  // Assignment
  assignedToId  String?         // Admin assigned to handle

  // Internal notes (not visible to student)
  internalNotes String?         @db.Text

  // Response tracking
  firstResponseAt DateTime?
  resolvedAt      DateTime?

  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  // Relations
  user       User              @relation("StudentMessages", fields: [userId], references: [id], onDelete: Cascade)
  course     Course?           @relation(fields: [courseId], references: [id], onDelete: SetNull)
  assignedTo User?             @relation("AssignedMessages", fields: [assignedToId], references: [id], onDelete: SetNull)
  replies    MessageReply[]

  @@index([userId])
  @@index([courseId])
  @@index([assignedToId])
  @@index([status])
  @@index([priority])
  @@index([createdAt])
  @@map("student_messages")
}

model MessageReply {
  id          String   @id @default(cuid())
  messageId   String
  userId      String   // User who replied (admin or student)
  content     String   @db.Text
  attachmentUrl String?
  isInternal  Boolean  @default(false) // Internal note not visible to student
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  message StudentMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user    User           @relation("MessageReplies", fields: [userId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@index([userId])
  @@index([createdAt])
  @@map("message_replies")
}

model CannedResponse {
  id          String   @id @default(cuid())
  title       String
  content     String   @db.Text
  category    String?  // support, greeting, follow-up, etc.
  shortcut    String?  // e.g., "/greeting" to quick insert
  isActive    Boolean  @default(true)
  usageCount  Int      @default(0)
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  createdBy User @relation("CannedResponses", fields: [createdById], references: [id], onDelete: Cascade)

  @@index([category])
  @@index([shortcut])
  @@map("canned_responses")
}

// Enhanced Review model - updating existing Review
model ReviewVote {
  id        String   @id @default(cuid())
  reviewId  String
  userId    String
  isHelpful Boolean  // true = helpful, false = not helpful
  createdAt DateTime @default(now())

  // Relations
  review Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  user   User   @relation("ReviewVotes", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([reviewId, userId])
  @@index([reviewId])
  @@index([userId])
  @@map("review_votes")
}

model ReviewResponse {
  id        String   @id @default(cuid())
  reviewId  String   @unique
  adminId   String
  content   String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  review Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  admin  User   @relation("ReviewResponses", fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId])
  @@map("review_responses")
}

model EmailLog {
  id            String   @id @default(cuid())
  toEmail       String
  toUserId      String?
  subject       String
  templateType  String   // welcome, review_approved, message_reply, etc.
  status        String   @default("sent") // sent, failed, bounced
  errorMessage  String?  @db.Text
  messageId     String?  // Email provider message ID
  metadata      Json?    // Additional email metadata
  createdAt     DateTime @default(now())

  @@index([toEmail])
  @@index([toUserId])
  @@index([templateType])
  @@index([status])
  @@index([createdAt])
  @@map("email_logs")
}

model CommunicationAnalytics {
  id                 String   @id @default(cuid())
  date               DateTime @db.Date

  // Message stats
  totalMessages      Int      @default(0)
  newMessages        Int      @default(0)
  resolvedMessages   Int      @default(0)
  avgResponseTimeMin Int?     // Average response time in minutes

  // Review stats
  totalReviews       Int      @default(0)
  approvedReviews    Int      @default(0)
  rejectedReviews    Int      @default(0)
  avgRating          Decimal? @db.Decimal(3, 2)

  // Email stats
  emailsSent         Int      @default(0)
  emailsFailed       Int      @default(0)

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@unique([date])
  @@index([date])
  @@map("communication_analytics")
}

// ==========================================
// COMPREHENSIVE ANALYTICS SYSTEM
// ==========================================

// Daily aggregated analytics for performance dashboard
model DailyAnalytics {
  id                  String   @id @default(cuid())
  date                DateTime @db.Date

  // Revenue metrics
  totalRevenue        Decimal  @default(0) @db.Decimal(10, 2)
  refundedAmount      Decimal  @default(0) @db.Decimal(10, 2)
  netRevenue          Decimal  @default(0) @db.Decimal(10, 2)
  totalPurchases      Int      @default(0)
  avgOrderValue       Decimal  @default(0) @db.Decimal(10, 2)
  newPurchases        Int      @default(0)

  // Student metrics
  newRegistrations    Int      @default(0)
  activeUsers         Int      @default(0) // Users who logged in
  totalLogins         Int      @default(0)
  avgSessionDuration  Int      @default(0) // seconds

  // Course metrics
  enrollments         Int      @default(0)
  completions         Int      @default(0)
  chaptersCompleted   Int      @default(0)

  // Engagement metrics
  totalComments       Int      @default(0)
  newReviews          Int      @default(0)
  videoViews          Int      @default(0)
  totalWatchTime      Int      @default(0) // seconds
  quizAttempts        Int      @default(0)
  quizPasses          Int      @default(0)

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@unique([date])
  @@index([date])
  @@map("daily_analytics")
}

// Revenue breakdown by course for detailed reporting
model CourseRevenueAnalytics {
  id              String   @id @default(cuid())
  courseId        String
  date            DateTime @db.Date

  revenue         Decimal  @default(0) @db.Decimal(10, 2)
  refunds         Decimal  @default(0) @db.Decimal(10, 2)
  purchases       Int      @default(0)
  avgPrice        Decimal  @default(0) @db.Decimal(10, 2)
  promoCodeUsage  Int      @default(0)
  discountGiven   Decimal  @default(0) @db.Decimal(10, 2)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([courseId, date])
  @@index([courseId])
  @@index([date])
  @@map("course_revenue_analytics")
}

// Student cohort analysis
model StudentCohort {
  id              String   @id @default(cuid())
  cohortMonth     DateTime @db.Date // First day of the month

  totalStudents   Int      @default(0)
  activeMonth1    Int      @default(0) // Still active after 1 month
  activeMonth2    Int      @default(0)
  activeMonth3    Int      @default(0)
  activeMonth6    Int      @default(0)
  activeMonth12   Int      @default(0)

  avgPurchases    Decimal  @default(0) @db.Decimal(5, 2)
  avgLifetimeValue Decimal @default(0) @db.Decimal(10, 2)
  churnRate       Decimal  @default(0) @db.Decimal(5, 2)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([cohortMonth])
  @@index([cohortMonth])
  @@map("student_cohorts")
}

// Chapter-level analytics for learning path analysis
model ChapterAnalytics {
  id                  String   @id @default(cuid())
  chapterId           String
  date                DateTime @db.Date

  views               Int      @default(0)
  starts              Int      @default(0)
  completions         Int      @default(0)
  avgTimeSpent        Int      @default(0) // seconds
  dropoffs            Int      @default(0)
  videoCompletionRate Decimal  @default(0) @db.Decimal(5, 2)

  // Quiz performance (if chapter has quiz)
  quizAttempts        Int      @default(0)
  quizPasses          Int      @default(0)
  avgQuizScore        Decimal  @default(0) @db.Decimal(5, 2)

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@unique([chapterId, date])
  @@index([chapterId])
  @@index([date])
  @@map("chapter_analytics")
}

// Geographic and device analytics
model GeoAnalytics {
  id              String   @id @default(cuid())
  date            DateTime @db.Date
  country         String
  region          String?
  city            String?

  users           Int      @default(0)
  revenue         Decimal  @default(0) @db.Decimal(10, 2)
  purchases       Int      @default(0)
  sessions        Int      @default(0)

  createdAt       DateTime @default(now())

  @@unique([date, country, region, city])
  @@index([date])
  @@index([country])
  @@map("geo_analytics")
}

model DeviceAnalytics {
  id              String   @id @default(cuid())
  date            DateTime @db.Date
  deviceType      String   // mobile, tablet, desktop
  browser         String?
  os              String?

  users           Int      @default(0)
  sessions        Int      @default(0)
  avgDuration     Int      @default(0) // seconds
  bounceRate      Decimal  @default(0) @db.Decimal(5, 2)

  createdAt       DateTime @default(now())

  @@unique([date, deviceType, browser, os])
  @@index([date])
  @@index([deviceType])
  @@map("device_analytics")
}

// Saved custom reports
model CustomReport {
  id              String   @id @default(cuid())
  name            String
  description     String?
  createdById     String

  // Report configuration
  reportType      String   // dashboard, revenue, students, courses, custom
  config          Json     // Chart types, metrics, filters, date range
  layout          Json?    // Grid layout for dashboard widgets

  // Scheduling
  isScheduled     Boolean  @default(false)
  scheduleFrequency String? // daily, weekly, monthly
  scheduledDay    Int?     // Day of week (0-6) or day of month (1-31)
  scheduleTime    String?  // HH:MM format
  emailRecipients String[] // Email addresses to send to
  lastSentAt      DateTime?

  isPublic        Boolean  @default(false)
  isTemplate      Boolean  @default(false)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([createdById])
  @@index([isScheduled])
  @@map("custom_reports")
}

// Export jobs tracking
model ExportJob {
  id              String   @id @default(cuid())
  userId          String

  exportType      String   // csv, excel, pdf
  reportType      String   // revenue, students, courses, custom
  filters         Json?    // Applied filters
  dateRange       Json?    // Start and end date

  status          String   @default("pending") // pending, processing, completed, failed
  progress        Int      @default(0) // 0-100
  fileUrl         String?
  fileName        String?
  fileSize        Int?     // bytes
  errorMessage    String?

  startedAt       DateTime?
  completedAt     DateTime?
  expiresAt       DateTime? // When the file will be deleted

  createdAt       DateTime @default(now())

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("export_jobs")
}

// Real-time activity tracking
model ActivityLog {
  id              String   @id @default(cuid())
  userId          String?
  sessionId       String?

  activityType    String   // page_view, video_play, quiz_start, purchase, login, etc.
  resourceType    String?  // course, chapter, video, quiz
  resourceId      String?

  metadata        Json?    // Additional activity data
  ipAddress       String?
  userAgent       String?

  createdAt       DateTime @default(now())

  @@index([userId])
  @@index([sessionId])
  @@index([activityType])
  @@index([createdAt])
  @@map("activity_logs")
}

// Performance monitoring
model PerformanceMetric {
  id              String   @id @default(cuid())
  metricType      String   // page_load, api_response, video_buffer, error_rate
  endpoint        String?  // API endpoint or page path

  avgValue        Decimal  @db.Decimal(10, 2) // Average time/rate
  minValue        Decimal  @db.Decimal(10, 2)
  maxValue        Decimal  @db.Decimal(10, 2)
  p50Value        Decimal  @db.Decimal(10, 2) // Median
  p95Value        Decimal  @db.Decimal(10, 2) // 95th percentile
  p99Value        Decimal  @db.Decimal(10, 2) // 99th percentile
  sampleCount     Int

  hour            DateTime // Aggregated by hour

  createdAt       DateTime @default(now())

  @@unique([metricType, endpoint, hour])
  @@index([metricType])
  @@index([hour])
  @@map("performance_metrics")
}

// Predictive analytics data
model PredictiveData {
  id              String   @id @default(cuid())
  userId          String?
  courseId        String?

  predictionType  String   // churn_risk, revenue_forecast, completion_prediction
  confidenceScore Decimal  @db.Decimal(5, 2)
  predictedValue  Decimal? @db.Decimal(10, 2)
  predictedDate   DateTime?

  factors         Json?    // Contributing factors to the prediction

  isActualized    Boolean  @default(false)
  actualValue     Decimal? @db.Decimal(10, 2)
  actualizedAt    DateTime?

  createdAt       DateTime @default(now())
  expiresAt       DateTime?

  @@index([userId])
  @@index([courseId])
  @@index([predictionType])
  @@index([createdAt])
  @@map("predictive_data")
}

// Promo code analytics
model PromoCodeAnalytics {
  id              String   @id @default(cuid())
  promoCodeId     String
  date            DateTime @db.Date

  usageCount      Int      @default(0)
  revenue         Decimal  @default(0) @db.Decimal(10, 2)
  discountGiven   Decimal  @default(0) @db.Decimal(10, 2)
  uniqueUsers     Int      @default(0)

  createdAt       DateTime @default(now())

  @@unique([promoCodeId, date])
  @@index([promoCodeId])
  @@index([date])
  @@map("promo_code_analytics")
}

// ==========================================
// COURSE SUBMISSION SYSTEM
// ==========================================

enum CourseSubmissionStatus {
  NEW
  REVIEWING
  APPROVED
  REJECTED
}

model CourseSubmission {
  id              String                  @id @default(cuid())

  // Personal info
  firstName       String
  lastName        String
  email           String
  phone           String

  // Course info
  courseTitle     String
  courseDescription String                @db.Text

  // Files & Links
  driveLink       String?                 // Google Drive link (optional)

  // Status
  status          CourseSubmissionStatus  @default(NEW)
  adminNotes      String?                 @db.Text

  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt

  // Relations
  files           CourseSubmissionFile[]

  @@index([email])
  @@index([status])
  @@index([createdAt])
  @@map("course_submissions")
}

model CourseSubmissionFile {
  id              String           @id @default(cuid())
  submissionId    String
  fileName        String           // Original file name
  filePath        String           // Path in storage
  fileSize        Int              // Size in bytes
  mimeType        String           // e.g., application/pdf, video/mp4
  createdAt       DateTime         @default(now())

  // Relations
  submission      CourseSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@index([submissionId])
  @@map("course_submission_files")
}

// ==========================================
// FAQ SYSTEM
// ==========================================

model FAQ {
  id        String   @id @default(cuid())
  question  String
  answer    String   @db.Text
  category  String?  // Optional categorization
  order     Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([order])
  @@index([isActive])
  @@map("faqs")
}

// ==========================================
// SLIDER SYSTEM
// ==========================================

model Slider {
  id        String   @id @default(cuid())
  imageUrl  String   // Image URL (R2 storage)
  linkUrl   String?  // Optional click-through link
  order     Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([order])
  @@index([isActive])
  @@map("sliders")
}

// ==========================================
// INSTRUCTOR SYSTEM
// ==========================================

model Instructor {
  id          String   @id @default(cuid())
  firstName   String
  lastName    String
  slug        String   @unique
  profession  String
  bio         String?  @db.Text
  avatar      String?
  email       String?
  facebook    String?
  linkedin    String?
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  courses     Course[]

  @@index([slug])
  @@index([isActive])
  @@index([order])
  @@map("instructors")
}
